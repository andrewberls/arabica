// Generated by CoffeeScript 1.3.3
(function() {
  var color, compile, concatenate, config, files, fs, read_config;

  color = require('cli-color');

  fs = require('fs');

  files = [];

  config = {};

  read_config = function() {
    var config_path;
    config_path = "" + (process.cwd()) + "/config.json";
    if (fs.existsSync(config_path)) {
      try {
        return JSON.parse(fs.readFileSync(config_path, 'utf8'));
      } catch (err) {
        return process.exit(1);
      }
    } else {
      console.error(color.red("No config.json file found in " + (process.cwd())));
      return process.exit(1);
    }
  };

  exports.build = function(dir) {
    var fileObj, path, _, _i, _len, _ref;
    _ = require('underscore');
    if (dir) {
      try {
        process.chdir(dir);
      } catch (err) {
        console.error(color.red("Directory not found: " + dir));
        process.exit(1);
      }
    }
    config = _.defaults(read_config(), {
      "out": "build.js",
      "uglify": true,
      "paths": []
    });
    if (fs.existsSync(config.out)) {
      fs.unlinkSync(config.out);
    }
    _ref = config.paths;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      path = _ref[_i];
      if (!fs.existsSync(path)) {
        console.warn(color.yellow("File " + path + " doesn't exist, skipping"));
        continue;
      }
      if (fs.statSync(path).isFile()) {
        fileObj = {
          path: path,
          language: path.substring(path.lastIndexOf('.') + 1),
          content: ''
        };
        fileObj.content = fs.readFileSync(path);
        files.push(fileObj);
      }
    }
    concatenate();
    compile();
    return console.log(color.green("Successfully compiled to " + config.out));
  };

  concatenate = function() {
    var file, outfile, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      outfile = (function() {
        switch (file.language) {
          case "js":
            return config.out;
          case "coffee":
            return "__in.coffee";
        }
      })();
      _results.push(fs.appendFileSync(outfile, file.content));
    }
    return _results;
  };

  compile = function() {
    var UglifyJS, coffee, output;
    coffee = require('coffee-script');
    output = coffee.compile(fs.readFileSync('__in.coffee').toString(), {
      bare: true
    });
    if (config.uglify === true) {
      UglifyJS = require("uglify-js");
      output = UglifyJS.minify(output, {
        fromString: true
      }).code;
    }
    fs.appendFileSync(config.out, output);
    return fs.unlinkSync('__in.coffee');
  };

  exports.clean = function() {
    config = read_config();
    if (fs.existsSync(config.out)) {
      fs.unlinkSync(config.out);
      return console.log(color.green("Removed " + config.out + "."));
    } else {
      return console.warn(color.yellow("Nothing to do here (file not found: " + config.out + ")"));
    }
  };

}).call(this);
